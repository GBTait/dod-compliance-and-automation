# VMware vSphere 7.0 ESXi Ansible Role

---

 #---------- Ansible version 2.10 --------#

############################################

- name: Disabling Lockdown Mode if it is on to run the playbook.
  community.vmware.vmware_host_lockdown:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    state: absent
    validate_certs: '{{ validate_certs }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  when:
  - run_lockdown_mode | bool

- name: Enabling SSH if it is off to run the playbook.
  community.vmware.vmware_host_service_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    service_name: TSM-SSH
    validate_certs: '{{ validate_certs }}'
    state: start
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000035
  when:
  - run_disable_ssh | bool

############################################

- name: ESXI-70-000002 - The ESXi host must verify the DCUI.Access list.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'DCUI.Access': '{{ var_dcui_access }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000002
  when:
  - run_dcui_access | bool

############################################

- name: ESXI-70-000003 - The ESXi host must verify the exception users list for Lockdown Mode.
  debug:
    msg: Remove any unauthorized users from the lockdown exception users list manually.
  tags:
  - ESXI-70-000003
  when:
  - run_lockdown_exceptions | bool

############################################

- name: ESXI-70-000004 - Remote logging for ESXi hosts must be configured.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Syslog.global.logHost': '{{ var_syslog_servers }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000004
  when:
  - run_syslog_servers | bool

############################################

- name: ESXI-70-000005 - The ESXi host must enforce the limit of three consecutive invalid logon attempts by a user.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Security.AccountLockFailures': '{{ var_account_lock_failures }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000005
  when:
  - run_account_lock_failures | bool

############################################

- name: ESXI-70-000006 - The ESXi host must enforce an unlock timeout of 15 minutes after a user account is locked out.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Security.AccountUnlockTime': '{{ var_account_lock_time }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000006
  when:
  - run_account_lock_time | bool

############################################

- name: ESXI-70-000007 - The ESXi host must display the Standard Mandatory DoD Notice and Consent Banner before granting access to the system via the DCUI.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Annotations.WelcomeMessage': '{{ var_dcui_welcome_message }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000007
  when:
  - run_dcui_welcome_message | bool

############################################

- name: ESXI-70-000008 - The ESXi host must display the Standard Mandatory DoD Notice and Consent Banner before granting access to the system via SSH.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Config.Etc.issue': '{{ var_etc_issue_banner }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000008
  when:
  - run_etc_issue_banner | bool

############################################

- name: ESXI-70-000009 - The ESXi host SSH daemon must be configured with the DoD logon banner.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^Banner.*$'
    line: Banner {{ var_sshd_banner }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000009
  when:
  - run_sshd_banner | bool

############################################

- name: ESXI-70-000010 - The ESXi host SSH daemon must use FIPS 140-2 validated cryptographic modules to protect the confidentiality of remote access sessions.
  ansible.builtin.shell: esxcli system security fips140 ssh get | grep -q true && echo -n TRUE || esxcli system security fips140 ssh set -e true
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  register: result
  changed_when: result.stdout != 'TRUE'
  tags:
  - ESXI-70-000010
  when:
  - run_sshd_fips_mode | bool

############################################

- name: ESXI-70-000012 - The ESXi host SSH daemon must ignore .rhosts files.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^IgnoreRhosts.*$'
    line: IgnoreRhosts {{ var_sshd_ignorerhosts }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000012
  when:
  - run_sshd_ignorerhosts | bool

############################################

- name: ESXI-70-000013 - The ESXi host SSH daemon must not allow host-based authentication.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^HostbasedAuthentication.*$'
    line: HostbasedAuthentication {{ var_sshd_hostbasedauth }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000013
  when:
  - run_sshd_hostbasedauth | bool

############################################

- name: ESXI-70-000014 - The ESXi host SSH daemon must not permit root logins.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^PermitRootLogin.*$'
    line: PermitRootLogin {{ var_sshd_permitroot }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000014
  when:
  - run_sshd_permitroot | bool

############################################

- name: ESXI-70-000015 - The ESXi host SSH daemon must not allow authentication using an empty password.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^PermitEmptyPasswords.*$'
    line: PermitEmptyPasswords {{ var_sshd_permitemptypasswords }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000015
  when:
  - run_sshd_permitemptypasswords | bool

############################################

- name: ESXI-70-000016 - The ESXi host SSH daemon must not permit user environment settings.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^PermitUserEnvironment.*$'
    line: PermitUserEnvironment {{ var_sshd_permituserenvironment }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000016
  when:
  - run_sshd_permituserenvironment | bool

############################################

- name: ESXI-70-000020 - The ESXi host SSH daemon must perform strict mode checking of home directory configuration files.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^StrictModes.*$'
    line: StrictModes {{ var_sshd_strictmodes }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000020
  when:
  - run_sshd_strictmodes | bool

############################################

- name: ESXI-70-000021 - The ESXi host SSH daemon must not allow compression or must only allow compression after successful authentication.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^Compression.*$'
    line: Compression {{ var_sshd_compression }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000021
  when:
  - run_sshd_compression | bool

############################################

- name: ESXI-70-000022 - The ESXi host SSH daemon must be configured to not allow gateway ports.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^GatewayPorts.*$'
    line: GatewayPorts {{ var_sshd_gatewayports }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000022
  when:
  - run_sshd_gatewayports | bool

############################################

- name: ESXI-70-000023 - The ESXi host SSH daemon must be configured to not allow X11 forwarding.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^X11Forwarding.*$'
    line: X11Forwarding {{ var_sshd_x11forwarding }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000023
  when:
  - run_sshd_x11forwarding | bool

############################################

- name: ESXI-70-000025 - The ESXi host SSH daemon must not permit tunnels.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^PermitTunnel.*$'
    line: PermitTunnel {{ var_sshd_permittunnel }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000025
  when:
  - run_sshd_permittnnel | bool

############################################

- name: ESXI-70-000026 - The ESXi host SSH daemon must set a timeout count on idle sessions.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^ClientAliveCountMax.*$'
    line: ClientAliveCountMax {{ var_sshd_clientalivecountmax }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000026
  when:
  - run_sshd_clientalivecountmax | bool

############################################

- name: ESXI-70-000027 - The ESXi host SSH daemon must set a timeout interval on idle sessions.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^ClientAliveInterval.*$'
    line: ClientAliveInterval {{ var_sshd_clientaliveinterval }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000027
  when:
  - run_sshd_clientaliveinterval | bool

############################################

- name: ESXI-70-000030 - The ESXi host must produce audit records containing information to establish what type of events occurred.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Config.HostAgent.log.level': '{{ var_host_agent_log_level }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000030
  when:
  - run_host_agent_log_level | bool

############################################

- name: ESXI-70-000031 - The ESXi host must be configured with a sufficiently complex password policy.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Security.PasswordQualityControl': '{{ var_security_password_quality_control }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000031
  when:
  - run_security_password_quality_control | bool

############################################

- name: ESXI-70-000032 - The ESXi host must prohibit the reuse of passwords within five iterations.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Security.PasswordHistory': '{{ var_security_password_history }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000032
  when:
  - run_security_password_history | bool

############################################

- name: ESXI-70-000033 - The password hashes stored on the ESXi host must have been generated using a FIPS 140-2 approved cryptographic hashing algorithm.
  community.general.pamd:
    name: passwd
    type: password
    control: sufficient
    module_path: pam_unix.so
    module_arguments: 'sha512'
    state: args_present
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000033
  when:
  - run_pamd_encryption | bool

############################################

- name: ESXI-70-000034 - The ESXi host must disable the Managed Object Browser (MOB).
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Config.HostAgent.plugins.solo.enableMob': '{{ var_enable_mob }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000034
  when:
  - run_enable_mob | bool

############################################

- name: ESXI-70-000036 - The ESXi host must disable ESXi Shell unless needed for diagnostics or troubleshooting.
  community.vmware.vmware_host_service_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    service_name: TSM
    validate_certs: '{{ validate_certs }}'
    state: stop
    service_policy: off
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000036
  when:
  - run_disable_shell | bool

############################################

- name: ESXI-70-000037 - The ESXi host must use Active Directory for local user authentication.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000037
  when:
  - run_ad_auth | bool

############################################

- name: ESXI-70-000038 - ESXi hosts using Host Profiles and/or Auto Deploy must use the vSphere Authentication Proxy to protect passwords when adding themselves to Active Directory.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000038
  when:
  - run_ad_auth_proxy | bool

############################################

- name: ESXI-70-000039 - Active Directory ESX Admin group membership must not be used when adding ESXi hosts to Active Directory.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Config.HostAgent.plugins.hostsvc.esxAdminsGroup': '{{ var_ad_admin_group }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000039
  when:
  - run_ad_admin_group | bool

############################################

- name: ESXI-70-000041 - The ESXi host must set a timeout to automatically disable idle shell sessions after two minutes.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'UserVars.ESXiShellInteractiveTimeOut': '{{ var_shell_interactive_timeout }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000041
  when:
  - run_shell_interactive_timeout | bool

############################################

- name: ESXI-70-000042 - The ESXi host must terminate shell services after 10 minutes.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'UserVars.ESXiShellTimeOut': '{{ var_shell_timeout }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000042
  when:
  - run_shell_timeout | bool

############################################

- name: ESXI-70-000043 - The ESXi host must log out of the console UI after two minutes.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'UserVars.DcuiTimeOut': '{{ var_dcui_timeout }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000043
  when:
  - run_dcui_timeout | bool

############################################

- name: ESXI-70-000045 - The ESXi host must log out of the console UI after two minutes.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Syslog.global.logDir': '{{ var_syslog_global_logdir }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000045
  when:
  - run_syslog_global_logdir | bool

############################################

- name: ESXI-70-000046 - The ESXi host must configure NTP time synchronization.
  community.vmware.vmware_host_ntp:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    state: present
    ntp_servers:
      - '{{ var_ntp_server_1 }}'
      - '{{ var_ntp_server_2 }}'
    validate_certs: '{{ validate_certs }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000046
  when:
  - run_configure_ntp | bool

- name: ESXI-70-000046 - The ESXi host must configure NTP time synchronization.
  community.vmware.vmware_host_service_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    service_name: ntpd
    validate_certs: '{{ validate_certs }}'
    state: start
    service_policy: on
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000046
  when:
  - run_configure_ntp | bool

############################################

- name: ESXI-70-000047 - The ESXi Image Profile and vSphere Installation Bundle (VIB) Acceptance Levels must be verified.
  community.vmware.vmware_host_acceptance:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    acceptance_level: '{{ var_vib_acceptance_level }}'
    state: present
    validate_certs: '{{ validate_certs }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000047
  when:
  - run_vib_acceptance_level | bool

############################################

- name: ESXI-70-000048 - The ESXi host must protect the confidentiality and integrity of transmitted information by isolating vMotion traffic.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000048
  when:
  - run_vmotion_isolation | bool

############################################

- name: ESXI-70-000049 - The ESXi host must protect the confidentiality and integrity of transmitted information by protecting ESXi management traffic.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000049
  when:
  - run_management_isolation | bool

############################################

- name: ESXI-70-000050 - The ESXi host must protect the confidentiality and integrity of transmitted information by isolating IP-based storage traffic
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000050
  when:
  - run_storage_isolation | bool

############################################

- name: ESXI-70-000053 - SNMP must be configured properly on the ESXi host. Reseting any configured v2 targets
  ansible.builtin.shell: esxcli system snmp get | grep Enable | grep -q false && echo -n GOOD ||  esxcli system snmp set -e no
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  register: result
  changed_when: result.stdout != 'GOOD'
  tags:
  - ESXI-70-000053
  when:
  - run_disable_snmp_v2 | bool

- name: ESXI-70-000053 - SNMP must be configured properly on the ESXi host. Configure v3
  debug:
    msg: SNMP v3 targets must be configured manually if needed.
  tags:
  - ESXI-70-000053
  when:
  - run_disable_snmp_v2 | bool

############################################

- name: ESXI-70-000054 - The ESXi host must enable bidirectional CHAP authentication for iSCSI traffic.
  debug:
    msg: This control must be remediated manually or through other means. Can be done through ansible but customers should evaluate their environment to see if it is suitable for automation.
  tags:
  - ESXI-70-000054
  when:
  - run_iscsi_mutual_chap | bool

############################################

- name: ESXI-70-000055 - The ESXi host must disable Inter-VM transparent page sharing.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Mem.ShareForceSalting': '{{ var_mem_share_force_salting }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000055
  when:
  - run_mem_share_force_salting | bool

############################################

- name: ESXI-70-000056 - The ESXi host must configure the firewall to restrict access to services running on the host.
  debug:
    msg: This control must be remediated manually or through other means. Can be done through ansible but customers should evaluate their environment to see if it is suitable for automation.
  tags:
  - ESXI-70-000056
  when:
  - run_firewall_rules_services | bool

############################################

- name: ESXI-70-000057 - The ESXi host must configure the firewall to block network traffic by default.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000057
  when:
  - run_firewall_default | bool

############################################

- name: ESXI-70-000058 - The ESXi host must enable BPDU filter on the host to prevent being locked out of physical switch ports with Portfast and BPDU Guard enabled.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Net.BlockGuestBPDU': '{{ var_net_block_guest_bpdu }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000058
  when:
  - run_net_block_guest_bpdu | bool

############################################

- name: ESXI-70-000059 - All port groups on standard switches must be configured to reject forged transmits. Register all hosts vSwitches
  community.vmware.vmware_vswitch_info:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
  register: vswitch_info
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000059
  when:
  - run_reject_forged_transmits | bool
  
# - name: vSwitch Results
#   debug:
#     var: vswitch_info.results.[0]
#   loop: '{{ vswitch_info.results }}'
#   tags:
#   - ESXI-70-000059
#   when:
#   - run_reject_forged_transmits | bool

############################################

- name: ESXI-70-000060 - All port groups on standard switches must be configured to reject guest MAC address changes.
  debug:
    msg: Placeholder for this control.
  tags:
  - ESXI-70-000060
  when:
  - run_reject_mac_changes | bool

############################################

- name: ESXI-70-000061 - All port groups on standard switches must be configured to reject guest promiscuous mode requests.
  debug:
    msg: Placeholder for this control.
  tags:
  - ESXI-70-000061
  when:
  - run_reject_prom_mode | bool

############################################

- name: ESXI-70-000062 - Use of the dvFilter network APIs must be restricted.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Net.DVFilterBindIpAddress': ''
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000062
  when:
  - run_net_dvfilter_bind_address | bool

############################################

- name: ESXI-70-000063 - All port groups on standard switches must be configured to a value other than that of the native VLAN.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000063
  when:
  - run_net_native_vlan | bool

############################################

- name: ESXI-70-000064 - All port groups on standard switches must not be configured to VLAN 4095 unless Virtual Guest Tagging (VGT) is required.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000064
  when:
  - run_net_vlan_trunk | bool

############################################

- name: ESXI-70-000065 - All port groups on standard switches must not be configured to VLAN values reserved by upstream physical switches.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000065
  when:
  - run_net_vlan_reserved | bool

############################################

- name: ESXI-70-000070 - The ESXi host must not provide root/administrator-level access to CIM-based hardware monitoring tools or other third-party applications.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000070
  when:
  - run_cim_accounts | bool

############################################

- name: ESXI-70-000072 - The ESXi host must have all security patches and updates installed.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000072
  when:
  - run_esxi_updates | bool

############################################

- name: ESXI-70-000074 - The ESXi host must exclusively enable TLS 1.2 for all endpoints.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'UserVars.ESXiVPsDisabledProtocols': '{{ var_tls_protocols }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000074
  when:
  - run_tls_protocols | bool

############################################

- name: ESXI-70-000076 - The ESXi host must enable Secure Boot.
  debug:
    msg: Secureboot must be enabled in the BIOS.
  tags:
  - ESXI-70-000076
  when:
  - run_enable_secure_boot | bool

############################################

- name: ESXI-70-000078 - The ESXi host must use DoD-approved certificates.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000078
  when:
  - run_replace_certs | bool

############################################

- name: ESXI-70-000079 - The ESXi host must not suppress warnings that the local or remote shell sessions are enabled.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'UserVars.SuppressShellWarning': '{{ var_suppress_shell_warning }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000079
  when:
  - run_var_suppress_shell_warning | bool

############################################

- name: ESXI-70-000080 - The ESXi host must only run executables from approved VIBs.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'VMkernel.Boot.execInstalledOnly': '{{ var_exec_installed_only }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000080
  when:
  - run_exec_installed_only | bool

############################################

- name: ESXI-70-000081 - The ESXi host must not suppress warnings about unmitigated hyperthreading vulnerabilities.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'UserVars.SuppressHyperthreadWarning': '{{ var_suppress_ht_warning }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000081
  when:
  - run_suppress_ht_warning | bool

############################################

- name: ESXI-70-000082 - The ESXi host SSH daemon must disable port forwarding.
  lineinfile:
    path: '{{ var_sshd_config_file }}'
    state: present
    regexp: '^AllowTcpForwarding.*$'
    line: AllowTcpForwarding {{ var_sshd_allowtcpforwardning }}
    firstmatch: yes
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  tags:
  - ESXI-70-000082
  when:
  - run_sshd_allowtcpforwardning | bool

############################################

- name: ESXI-70-000083 - The ESXi host OpenSLP service must be disabled.
  community.vmware.vmware_host_service_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    service_name: slpd
    validate_certs: '{{ validate_certs }}'
    state: stop
    service_policy: off
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000083
  when:
  - run_disable_slpd | bool

############################################

- name: ESXI-70-000086 - The ESXi host must verify certificates for SSL syslog endpoints.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Syslog.global.logCheckSSLCerts': '{{ var_syslog_cert_check }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000086
  when:
  - run_syslog_cert_check | bool

############################################

- name: ESXI-70-000088 - The ESXi host must configure a session timeout for the vSphere API.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'Config.HostAgent.vmacore.soap.sessionTimeout': '{{ var_soap_session_timeout }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000088
  when:
  - run_soap_session_timeout | bool

############################################

- name: ESXI-70-000089 - The ESXi Host Client must be configured with a session timeout.
  community.vmware.vmware_host_config_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    validate_certs: '{{ validate_certs }}'
    options:
      'UserVars.HostClientSessionTimeout': '{{ var_host_client_session_timeout }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000089
  when:
  - run_host_client_session_timeout | bool

############################################

- name: ESXI-70-000090 - The ESXi host rhttpproxy daemon must use FIPS 140-2 validated cryptographic modules to protect the confidentiality of remote access sessions.
  ansible.builtin.shell: esxcli system security fips140 rhttpproxy get | grep -q true && echo -n TRUE ||esxcli system security fips140 rhttpproxy set -e true
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  register: result
  changed_when: result.stdout != 'TRUE'
  tags:
  - ESXI-70-000090
  when:
  - run_proxy_fips | bool

############################################

- name: ESXI-70-000092 - The ESXi host must not be configured to override virtual machine configurations.
  ansible.builtin.shell:  stat -c "%s" /etc/vmware/settings | grep -q 0 && echo -n TRUE || echo -n >/etc/vmware/settings
  loop: "{{ groups['esxi'] }}"
  delegate_to: '{{ item }}'
  register: result
  changed_when: result.stdout != 'TRUE'
  tags:
  - ESXI-70-000092
  when:
  - run_vmx_override | bool

############################################

- name: ESXI-70-000093 - The ESXi host must not be configured to override virtual machine logger settings.
  debug:
    msg: This control must be remediated manually or through other means.
  tags:
  - ESXI-70-000093
  when:
  - run_vmx_override_logging | bool

############################################
# Running this one last so other controls can complete first

- name: ESXI-70-000035 - The ESXi host must be configured to disable nonessential capabilities by disabling SSH.
  community.vmware.vmware_host_service_manager:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    service_name: TSM-SSH
    validate_certs: '{{ validate_certs }}'
    state: stop
    service_policy: off
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000035
  when:
  - run_disable_ssh | bool

############################################
# Running this one last so other controls can complete first

- name: ESXI-70-000001 - Access to the ESXi host must be limited by enabling Lockdown Mode.
  community.vmware.vmware_host_lockdown:
    hostname: '{{ vcenter_hostname }}'
    username: '{{ vcenter_username }}'
    password: '{{ vcenter_password }}'
    esxi_hostname: '{{ item }}'
    state: present
    validate_certs: '{{ validate_certs }}'
  loop: "{{ groups['esxi'] }}"
  delegate_to: localhost
  tags:
  - ESXI-70-000001
  - lockdown
  when:
  - run_lockdown_mode | bool